# GitHub Secrets Configuration

This document explains how to configure GitHub Secrets for the API testing CI/CD pipeline.

## Overview

Minimal credentials required for test execution are stored as GitHub Secrets and injected into the CI environment at runtime. Test data and authentication tokens are generated dynamically during test execution via API endpoints.

## Security Philosophy

**Tokens are NOT stored as secrets.** They are generated at runtime via authentication APIs and exist only in memory during test execution. This approach:

- ✅ Aligns with industry best practices
- ✅ Prevents token leakage across environments
- ✅ Ensures tokens are never persisted
- ✅ Simplifies credential rotation (happens automatically)

## Required Secrets (Minimal Set)

Only these secrets are required for CI/CD:

| Secret Name | Type | Description | Purpose |
|------------|------|-------------|---------|
| `TEST_ADMIN_EMAIL` | String | Email for test admin account | Pre-seed test data / admin operations |
| `TEST_ADMIN_PASSWORD` | String | Password for test admin account | Generate tokens via login API |
| `TEST_USER_EMAIL` | String | Email for test regular user | Generate tokens via login API |
| `TEST_USER_PASSWORD` | String | Password for test regular user | Generate tokens via login API |

That's it. **No TOKEN_*, PASSWORD_*, USER_ID_* arrays.** Everything else is generated at runtime.

## How Tokens Are Generated (Runtime)

### Workflow Execution Flow

```
1. GitHub Actions runner starts
2. MongoDB service starts
3. Node.js server starts
4. Postman collection runs
5. Pre-request script calls login API with TEST_ADMIN_EMAIL + TEST_ADMIN_PASSWORD
6. Token received in response
7. Token stored in Postman environment (memory only)
8. Tests execute with token
9. Token discarded after workflow completes
```

### Postman Pre-request Script (Example)

```javascript
// Pre-request script in Postman collection
// This runs before each test that needs authentication

const email = pm.environment.get('TEST_ADMIN_EMAIL');
const password = pm.environment.get('TEST_ADMIN_PASSWORD');

// Only generate if not already set
if (!pm.environment.get('TOKEN_ADMIN')) {
  pm.sendRequest({
    url: pm.environment.get('BASE_URL') + '/auth/signin',
    method: 'POST',
    header: {
      'Content-Type': 'application/json'
    },
    body: {
      mode: 'raw',
      raw: JSON.stringify({
        email: email,
        password: password
      })
    }
  }, function(err, response) {
    if (!err && response.code === 200) {
      const token = response.json().token;
      pm.environment.set('TOKEN_ADMIN', token);
    }
  });
}
```

This ensures tokens are **generated fresh** on each workflow run.

## Setup Instructions

### Step 1: Create Test Accounts (Local)

1. Start your backend server locally
2. Create test user accounts via signup API
   ```bash
   curl -X POST http://localhost:3000/api/users \
     -H "Content-Type: application/json" \
     -d '{
       "email": "testadmin@example.com",
       "password": "testadmin123"
     }'
   ```
3. Note the email and password

### Step 2: Add Secrets to GitHub

1. Go to repository **Settings → Secrets and variables → Actions**
2. Click **New repository secret**
3. Add these 4 secrets:

```
TEST_ADMIN_EMAIL = testadmin@example.com
TEST_ADMIN_PASSWORD = testadmin123
TEST_USER_EMAIL = testuser@example.com
TEST_USER_PASSWORD = testuser123
```

### Step 3: Verify Secrets

Run workflow manually to verify secrets are working:

1. Go to **Actions** tab
2. Select **API Tests** workflow
3. Click **Run workflow**
4. Check if tests execute successfully

## Environment Variables Auto-Generated at Runtime

These are captured from API responses during test execution:

| Variable | Generated By | Used In |
|----------|--------------|---------|
| `TOKEN_ADMIN` | Login API (pre-request script) | Admin operations |
| `TOKEN_USER` | Login API (pre-request script) | User operations |
| `USER_ID_ADMIN` | Login response | Admin endpoints |
| `USER_ID_USER` | Login response | User endpoints |
| `GAME_ID_*` | Game API response | Game operations |
| `MESSAGE_ID_*` | Message API response | Message operations |
| `FAVORITE_ID_*` | Favorites API response | Favorites operations |

**No setup needed** - these are auto-populated by collection scripts.

## Token Rotation Policy

**Automatic** - Tokens are generated on every workflow run, so rotation happens automatically.

If you need to rotate test credentials:

1. Update password in test database
2. Update corresponding secret in GitHub
3. Next workflow run uses new credentials

No token refresh needed.

## What NOT to Add as Secrets

❌ Authentication tokens (TOKEN_*)
❌ User IDs (USER_ID_*)
❌ Test data IDs (GAME_ID_*, MESSAGE_ID_*)
❌ Multiple password variants (PASSWORD_AUTH001, PASSWORD_AUTH002_INVALID, etc.)

These are handled by:
- Pre-request scripts (token generation)
- Response body extraction (ID capture)
- Collection variables (test data)

## Troubleshooting

### Tests fail with 401 Unauthorized

**Check:**
- ✓ TEST_ADMIN_EMAIL and TEST_ADMIN_PASSWORD are correct
- ✓ Test accounts exist in database
- ✓ Pre-request scripts are present in Postman collection
- ✓ Secrets are set for correct repository

**Debug:**
Add debug logging to pre-request script:
```javascript
console.log("Login response status:", response.code);
console.log("Login response body:", response.text());
```

### Tests fail with 404 Not Found

Check:
- ✓ MongoDB is running in CI
- ✓ Database has proper indexes
- ✓ API endpoints exist

### Secret value not recognized

- ✓ Check secret name matches **exactly** (case-sensitive)
- ✓ Verify secrets are in correct repository (not organization level)
- ✓ Try re-running workflow (GitHub may need moment to sync)

## Local Testing

Test secrets locally before CI:

```bash
# Export secrets to local environment
export TEST_ADMIN_EMAIL="testadmin@example.com"
export TEST_ADMIN_PASSWORD="testadmin123"

# Run tests locally
npm run api:test:all
```

Or create local `.env` and load via collection setup script.

## Security Checklist

Before committing:

- ✅ No real tokens in code
- ✅ No credentials in collection JSON
- ✅ Test accounts are non-production only
- ✅ Secrets are encrypted on GitHub
- ✅ Only essential credentials stored

## References

- [GitHub Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [Postman Pre-request Scripts](https://learning.postman.com/docs/writing-scripts/pre-request-scripts/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)
- [API Security](https://owasp.org/www-project-api-security/)



