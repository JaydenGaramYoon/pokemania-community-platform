name: API Tests

on:
  push:
    branches: [main, qa-testing, develop]
  pull_request:
    branches: [main, qa-testing, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Create CI Postman Environment
        run: |
          cat > api/postman/environments/ci.postman_environment.json << 'EOF'
          {
            "id": "pokemania-ci-env",
            "name": "CI",
            "values": [
              {
                "key": "___BASE_CONFIG___",
                "value": "",
                "enabled": false
              },
              {
                "key": "BASE_URL",
                "value": "http://localhost:3000",
                "enabled": true
              },
              {
                "key": "TOKEN_PUBLIC",
                "value": "",
                "enabled": true
              },
              {
                "key": "TOKEN_U001",
                "value": "${{ secrets.TOKEN_U001 }}",
                "enabled": true
              },
              {
                "key": "TOKEN_U002",
                "value": "${{ secrets.TOKEN_U002 }}",
                "enabled": true
              },
              {
                "key": "TOKEN_U003",
                "value": "${{ secrets.TOKEN_U003 }}",
                "enabled": true
              },
              {
                "key": "TOKEN_U004",
                "value": "${{ secrets.TOKEN_U004 }}",
                "enabled": true
              },
              {
                "key": "TOKEN_U005",
                "value": "${{ secrets.TOKEN_U005 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_U001",
                "value": "${{ secrets.PASSWORD_U001 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_U002",
                "value": "${{ secrets.PASSWORD_U002 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_U003",
                "value": "${{ secrets.PASSWORD_U003 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_TEST_SHORT",
                "value": "${{ secrets.PASSWORD_TEST_SHORT }}",
                "enabled": true
              },
              {
                "key": "EMAIL_U001",
                "value": "${{ secrets.EMAIL_U001 }}",
                "enabled": true
              },
              {
                "key": "EMAIL_U002",
                "value": "${{ secrets.EMAIL_U002 }}",
                "enabled": true
              },
              {
                "key": "EMAIL_U003",
                "value": "${{ secrets.EMAIL_U003 }}",
                "enabled": true
              },
              {
                "key": "EMAIL_TEST_DUPLICATE",
                "value": "${{ secrets.EMAIL_TEST_DUPLICATE }}",
                "enabled": true
              },
              {
                "key": "EMAIL_TEST_NOTFOUND",
                "value": "${{ secrets.EMAIL_TEST_NOTFOUND }}",
                "enabled": true
              },
              {
                "key": "EMAIL_TEST_SHORT",
                "value": "${{ secrets.EMAIL_TEST_SHORT }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH001",
                "value": "${{ secrets.PASSWORD_AUTH001 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH002_INVALID",
                "value": "${{ secrets.PASSWORD_AUTH002_INVALID }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH004",
                "value": "${{ secrets.PASSWORD_AUTH004 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH_SIGNUP001",
                "value": "${{ secrets.PASSWORD_AUTH_SIGNUP001 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH_SIGNUP002",
                "value": "${{ secrets.PASSWORD_AUTH_SIGNUP002 }}",
                "enabled": true
              },
              {
                "key": "PASSWORD_AUTH_SIGNUP003_SHORT",
                "value": "${{ secrets.PASSWORD_AUTH_SIGNUP003_SHORT }}",
                "enabled": true
              },
              {
                "key": "USER_ID_U001",
                "value": "${{ secrets.USER_ID_U001 }}",
                "enabled": true
              },
              {
                "key": "USER_ID_U002",
                "value": "${{ secrets.USER_ID_U002 }}",
                "enabled": true
              },
              {
                "key": "USER_ID_U003",
                "value": "${{ secrets.USER_ID_U003 }}",
                "enabled": true
              },
              {
                "key": "USER_ID_SET_TARGET",
                "value": "${{ secrets.USER_ID_SET_TARGET }}",
                "enabled": true
              },
              {
                "key": "GAME_ID_PUT_001",
                "value": "",
                "enabled": true
              },
              {
                "key": "GAME_ID_PUT_002",
                "value": "",
                "enabled": true
              },
              {
                "key": "GAME_ID_DEL_001",
                "value": "",
                "enabled": true
              },
              {
                "key": "GAME_ID_DEL_002",
                "value": "",
                "enabled": true
              },
              {
                "key": "MESSAGE_ID_EDIT_001",
                "value": "",
                "enabled": true
              },
              {
                "key": "MESSAGE_ID_DEL_001",
                "value": "",
                "enabled": true
              },
              {
                "key": "SENDER_U001",
                "value": "",
                "enabled": true
              },
              {
                "key": "SENDER_GUEST",
                "value": "",
                "enabled": true
              },
              {
                "key": "FAV-DEL-001",
                "value": "",
                "enabled": true
              }
            ],
            "_postman_variable_scope": "environment",
            "._postman_exported_at": "2025-12-30T00:00:00.000Z",
            "_postman_exported_using": "Postman/latest"
          }
          EOF

      - name: Start server
        run: npm run dev &
        env:
          MONGODB_URI: mongodb://localhost:27017/BBproject

      - name: Wait for server
        run: sleep 3

      - name: Run API Tests
        run: npx newman run "api/postman/Public API (Search).postman_collection.json" -e "api/postman/environments/ci.postman_environment.json" -r html,json --reporter-html-export=newman-report.html --reporter-json-export=newman-report.json

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-reports
          path: |
            newman-report.html
            newman-report.json
          retention-days: 30
